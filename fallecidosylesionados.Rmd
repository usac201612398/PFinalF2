---
title: "R Notebook"
output: html_notebook
---


Nombre: Brndon René Portillo González
Proyecto: Fase II:Final

### Se instalan algunas de las librerías para iniciar con la exploración y para utilizar algunos modelos de prediccion.

```{r}
install.packages(c("readxl", "dplyr","rpart","rpart.plot","haven","randomForest"))
```

### Se cargan librerias para manipulacion de fuentes
```{r}
library(readxl)
library(dplyr)
library(haven)
```

```{r}
ruta <- "C:/Users/Brandon Portillo/Desktop/Nueva carpeta/4to Trimestre/PFinalF2/Fallecidos y lesionados/Excel"

archivos_excel <- list.files(path = ruta, pattern = "\\.xls[x]?$", full.names = TRUE)
archivos_excel
```
Se pueden visualizar las 8 fuentes y a continuación se procede a consolidar las partes. En cada excel algunos tienen 3 hojas pero solo 1 de cada 3 contiene información y todas las fuentes se trata de la Sheet1 la que nos interesa consultar. Además se validó que las columnas se llamaran igual, la llave primaria se llamaba Num_corre, núm_corre y num_corre.Se eliminó la columna area_geo_ocurr ya que solo aparecia en 2 dataset y no contiene mayor segmentación.

```{r}
lista_datos <- lapply(archivos_excel, function(archivo) {
  
# Leer la hoja "Sheet1"
  df <- read_excel(archivo, sheet = "Sheet1")
  
  return(df)
})

# Combinar todos los dataframes en uno solo
datos_excel <- bind_rows(lista_datos)

# Verificar resultado
glimpse(datos_excel)
```

```{r}
head(datos_excel)
```

### Ahora se procede a importar la información de los archivos .sav 

```{r}
ruta_spss <- "C:/Users/Brandon Portillo/Desktop/Nueva carpeta/4to Trimestre/PFinalF2/Fallecidos y lesionados/SPSS"

archivos_spss <- list.files(path = ruta_spss, pattern = "\\.sav$", full.names = TRUE)
print(archivos_spss)

```

```{r}
# Leer cada archivo y guardar en una lista
lista_spss <- lapply(archivos_spss, function(archivo) {
  df <- read_sav(archivo)
  return(df)
})
```


### Se exploran las variables que están disponibles en cada elemento del conjunto SAV

```{r}

nombres_spss <- lapply(archivos_spss, function(archivo) {
  df <- read_sav(archivo)
  names(df)
})

for (i in seq_along(archivos_spss)) {
  cat("\n Archivo:", basename(archivos_spss[i]), "\n")
  print(nombres_spss[[i]])
}
```

### De los archivos SPSS solo se considera el del año 2021 ya que los demás están incompletos porque les faltan muchas variables a todos en diferentes puntos y eso no favorece nuestro proceso de mineria de datos.
```{r}

ruta_archivo <- "C:/Users/Brandon Portillo/Desktop/Nueva carpeta/4to Trimestre/PFinalF2/Fallecidos y lesionados/SPSS/2021-Fallecidos y lesionados.sav"

# Leer el archivo
fallecidos_2021 <- read_sav(ruta_archivo)

```

### Se remueve la columna que no encaja con el resto de información, entonces ya se disponen de 25 columnas en todas las presentaciones.
```{r}
fallecidos_2021 <- fallecidos_2021 %>%
  select(-zona_ciudad)
head(fallecidos_2021)
```

### Ahora se consolidará esta información con los 8 datasets de excel. La columna que se ignoró fue la de zona_ciudad ya que está redundante y no es comun respecto al otro dataset.

### Se procede a explorar que columnas coinciden entonces
```{r}
columnas_comunes <- intersect(names(datos_excel), names(fallecidos_2021))

length(columnas_comunes)    # cuántas columnas coinciden
columnas_comunes            # nombres de las columnas comunes
```


```{r}
datos_excel_comunes <- datos_excel[, columnas_comunes, drop = FALSE]
fallecidos_2021_comunes <- fallecidos_2021[, columnas_comunes, drop = FALSE]

# Se unen datasets
datos_consolidados <- bind_rows(datos_excel_comunes, fallecidos_2021_comunes)
head(datos_consolidados)
dim(datos_consolidados)
```

### Se procede a trabajar con los primeros modelos para analisis de los datos integrando la información de accidentes de transito de los años 2015 a 2023 respectivamente lo que corresponde a 9 años de registros históricos reportados por la PNC (91,367).

### A continuación se procede a aplicar los modelos de Arboles de decision...

# Arboles de decisión

### Se importan las librerias para este algoritmo.

```{r}
library(rpart)
library(rpart.plot)
```

```{r}
# Se crea una nueva columna llamada horario la cual indica que 1 es dia y 2 es noche.
datos_consolidados$horario <- ifelse( datos_consolidados$hora_ocu >= 6 &  datos_consolidados$hora_ocu <= 18, 1, 2)

#Se crean los factores para el primer modelo
data_arbol1 <- datos_consolidados %>%
  filter(fall_les %in% c(1, 2), sexo_per != 9, tipo_eve != 99, tipo_veh != 99, edad_per != 999)
data_arbol1$sexo_per <- factor(data_arbol1$sexo_per)
data_arbol1$tipo_eve <- factor(data_arbol1$tipo_eve)
data_arbol1$tipo_veh <- factor(data_arbol1$tipo_veh)
data_arbol1$depto_ocu <- factor(data_arbol1$depto_ocu)
data_arbol1$horario <- factor(data_arbol1$horario)
data_arbol1$fall_les <- factor(data_arbol1$fall_les)
data_arbol1$mes_ocu <- factor(data_arbol1$mes_ocu)
data_arbol1$mayor_menor<- factor(data_arbol1$mayor_menor)
```

### Se procede a revisar si está balanceada la variable fall_les que es la que se usara en el primer modelo.

```{r}
table(data_arbol1$fall_les)
```
### Se observa que de lesionados y muertes un mayor al 80% de los casos son lesionados por lo que se procedio a revisar por ciudad y el interior y se obtuvo la misma razon el problema es que el dataset está desbalanceado y no proporcionara mayor detalle para este modelo. 


```{r}
# Calcular conteos y porcentajes por departamento
resumen <- data_arbol1 %>%
  filter(fall_les %in% c(1, 2)) %>%
  group_by(depto_ocu, fall_les) %>%
  summarise(casos = n(), .groups = "drop") %>%
  group_by(depto_ocu) %>%
  summarise(
    Fallecido = sum(casos[fall_les == 1], na.rm = TRUE),
    Lesionado = sum(casos[fall_les == 2], na.rm = TRUE)
  ) %>%
  mutate(
    Total = Fallecido + Lesionado,
    pct_fallecido = round(Fallecido / Total * 100, 2),
    pct_lesionado = round(Lesionado / Total * 100, 2)
  ) %>%
  arrange(desc(pct_fallecido)) 
resumen
```


```{r}
# Calcular conteos y porcentajes por año de ocurrencia
resumen <- data_arbol1 %>%
  filter(fall_les %in% c(1, 2)) %>%
  group_by(año_ocu, fall_les) %>%
  summarise(casos = n(), .groups = "drop") %>%
  group_by(año_ocu) %>%
  summarise(
    Fallecido = sum(casos[fall_les == 1], na.rm = TRUE),
    Lesionado = sum(casos[fall_les == 2], na.rm = TRUE)
  ) %>%
  mutate(
    Total = Fallecido + Lesionado,
    pct_fallecido = round(Fallecido / Total * 100, 2),
    pct_lesionado = round(Lesionado / Total * 100, 2)
  ) %>%
  arrange(desc(pct_fallecido)) 
resumen
```


### Se observa que la mayoria de los casos son tendencia a lesionados analizando por lugar y año de ocurrencia, por lo tanto se confirma que en cuanto al rubro geografico y anual también hay desbalance. 
### Se indivualizó el análisis para la ciudad, para el interior y en el departamento Izabal donde hay mas porcentaje de fallecimientos y no se obtuvo ninguna segmentacion en este modelo.

```{r}

# Árbol con más variables y parámetros ajustados
arbol1 <- rpart(fall_les ~ 
                sexo_per + tipo_eve + tipo_veh + depto_ocu + horario + mayor_menor + mes_ocu,
                data = data_arbol1,
                method = "class")

rpart.plot(arbol1, type = 2, extra = 0, under = TRUE, fallen.leaves = TRUE,
           box.palette = "BuGn", main = "Árbol 1: Gravedad del accidente", cex=0.5)

```

### El arbol no despliega ramas por lo tanto se procedió a analizar por separado los casos (fallecimientos y lesionados) ya que es más la tendencia a lesionados y la muerte ya es una situación crítica. No obstante, hubo la misma situación que el dataset no proporcionó detalles entonces se balancea para dejar casos aleatorios con el mismo numero de casos para fallecidos como lesionados.


```{r}
#Se crean los factores para el primer modelo
data_arbol1bal <- datos_consolidados %>%
  filter(fall_les %in% c(1, 2), sexo_per != 9, tipo_eve != 99, tipo_veh != 99, edad_per != 999)
set.seed(123)
fallecidos <- data_arbol1bal %>% filter(fall_les == 1)
lesionados <- data_arbol1bal %>% filter(fall_les == 2) %>% sample_n(nrow(fallecidos))
data_bal <- bind_rows(fallecidos, lesionados)

# Convertir variables categóricas a factor
data_bal$sexo_per <- factor(data_bal$sexo_per)
data_bal$tipo_eve <- factor(data_bal$tipo_eve)
data_bal$tipo_veh <- factor(data_bal$tipo_veh)
data_bal$depto_ocu <- factor(data_bal$depto_ocu)
data_bal$horario <- factor(data_bal$horario)
data_bal$mes_ocu <- factor(data_bal$mes_ocu)
data_bal$fall_les <- factor(data_bal$fall_les)
```

### Con el dataset balanceado entonces ya se puede verificar como quedaron distribuidos los casos para determinar el resto de las predicciones.

```{r}
# Calcular conteos y porcentajes por departamento
resumen <- data_bal %>%
  filter(fall_les %in% c(1, 2)) %>%
  group_by(depto_ocu, fall_les) %>%
  summarise(casos = n(), .groups = "drop") %>%
  group_by(depto_ocu) %>%
  summarise(
    Fallecido = sum(casos[fall_les == 1], na.rm = TRUE),
    Lesionado = sum(casos[fall_les == 2], na.rm = TRUE)
  ) %>%
  mutate(
    Total = Fallecido + Lesionado,
    pct_fallecido = round(Fallecido / Total * 100, 2),
    pct_lesionado = round(Lesionado / Total * 100, 2)
  ) %>%
  arrange(desc(pct_fallecido)) 
resumen
```


```{r}
table(data_bal$fall_les)
```

## Modelo 1: Predecir gravedad (fall_les) - Dataset balanceado

```{r}

# Árbol con más variables y parámetros ajustados
arbol1 <- rpart(fall_les ~ sexo_per + tipo_eve + tipo_veh + depto_ocu ,
                data = data_bal, method = "class")

rpart.plot(arbol1, type = 2, extra = 0, under = TRUE, fallen.leaves = TRUE,
           box.palette = "BuGn", main = "Árbol 1: Gravedad del accidente", cex=0.5)

```
```{r}
barplot(arbol1$variable.importance, main="Importancia de variables", col="steelblue")
```


### Se observa que para el modelo 1 con los datos balanceados ya se aprecia que las variables predictoras que influyen son sexo, tipo de evento, departamento donde sucedio y el tipo de vehiculo.


```{r}

# 5 escenarios distintos
escenarios <- data.frame(
  sexo_per  = factor(c(2, 1, 2, 1, 2), levels = levels(data_bal$sexo_per)),   # Mujer/Hombre
  tipo_eve  = factor(c(2, 5, 3, 1, 6), levels = levels(data_bal$tipo_eve)),   # Choque, Atropello, Vuelco, Colisión, Derrape
  tipo_veh  = factor(c(4, 1, 3, 2, 5), levels = levels(data_bal$tipo_veh)),   # Motocicleta, Automóvil, Pick up, Camioneta sport, Camión
  depto_ocu = factor(c(1, 6, 14, 18, 22), levels = levels(data_bal$depto_ocu)) # Guatemala, Santa Rosa, Quiché, Izabal, Jutiapa
)

# Ver el dataframe
escenarios

```
```{r}
## Predicciones con probabilidades para los 5 casos
predicciones <- predict(arbol1, escenarios, type = "prob")
predicciones
```

## Modelo 2: Predecir tipo de evento (tipo_eve)
### Se valido que el tipo de evento más comun que desbalanceaba la clase fue el de colisión por lo tanto se excluyo ese caso para ver que tan probable es que sucedan los otros eventos.
```{r}

data_arbol2 <- datos_consolidados %>%
  filter(fall_les %in% c(1, 2), sexo_per != 9, tipo_eve != 99,tipo_eve!=1, tipo_veh != 99, edad_per != 999)
data_arbol2$tipo_veh <- factor(data_arbol2$tipo_veh)
data_arbol2$depto_ocu <- factor(data_arbol2$depto_ocu)
data_arbol2$horario <- factor(data_arbol2$horario)
data_arbol2$fall_les <- factor(data_arbol2$fall_les)
data_arbol2$mayor_menor <- factor(data_arbol2$mayor_menor)
data_arbol2$sexo_per <- factor(data_arbol2$sexo_per)
table(data_arbol1$tipo_eve)
table(data_arbol2$tipo_eve)
```

```{r}

arbol2 <- rpart(tipo_eve ~  tipo_veh +depto_ocu + fall_les + mayor_menor + horario + sexo_per,
                data = data_arbol2, method = "class")
rpart.plot(arbol2,type=2,extra=0, under=TRUE,fallen.leaves = TRUE,box.palette = "BuGn", main = "Árbol 2: Tipo de evento", cex=0.5)

```
```{r}
barplot(arbol2$variable.importance, main="Importancia de variables", col="steelblue")
```
### Se observa que las tres variables predictoras que aportan son 3 de 5 que se ingresaron

```{r}

# 5 escenarios distintos
escenarios <- data.frame(
  sexo_per  = factor(c(2, 1, 2, 1, 2), levels = levels(data_arbol2$sexo_per)),   # Mujer/Hombre
  horario  = factor(c(1, 2, 1, 1, 2), levels = levels(data_arbol2$horario)),   # Día, Noche
  mayor_menor  = factor(c(1, 2, 2, 1, 1), levels = levels(data_arbol2$mayor_menor)),   # Mayor,Menor
  tipo_veh  = factor(c(4, 1, 3, 2, 5), levels = levels(data_arbol2$tipo_veh)),   # Motocicleta, Automóvil, Pick up, Camioneta sport, Camión
  depto_ocu = factor(c(1, 6, 14, 18, 22), levels = levels(data_arbol2$depto_ocu)), # Guatemala, Santa Rosa, Quiché, Izabal, Jutiapa
  fall_les = factor(c(1, 1, 2, 2, 2), levels = levels(data_arbol2$fall_les)) # Guatemala, Santa Rosa, Quiché, Izabal, Jutiapa
)

# Ver el dataframe
escenarios

```

```{r}
## Predicciones con probabilidades para los 5 casos
predicciones <- predict(arbol2, escenarios, type = "prob")
predicciones
```
## Modelo 3: Predcir tipo de vehiculo

### Se excluyen los casos en motocicletas porque estos son los que predominan y desbalancean el dataset.

```{r}
data_arbol3 <- datos_consolidados %>%
  filter(fall_les %in% c(1, 2), sexo_per != 9, tipo_eve != 99, tipo_veh != 99,tipo_veh != 4, edad_per != 999)
data_arbol3$sexo_per <- factor(data_arbol3$sexo_per)
data_arbol3$tipo_eve <- factor(data_arbol3$tipo_eve)
data_arbol3$tipo_veh <- factor(data_arbol3$tipo_veh)
data_arbol3$depto_ocu <- factor(data_arbol3$depto_ocu)
data_arbol3$zona_ocu <- factor(data_arbol3$zona_ocu)
data_arbol3$fall_les <- factor(data_arbol3$fall_les)
data_arbol3$horario <- factor(data_arbol3$horario)
data_arbol3$mayor_menor <- factor(data_arbol3$mayor_menor)
table(data_arbol3$tipo_veh)
```


```{r}

# Árbol para tipo de vehículo
arbol3 <- rpart(tipo_veh ~ tipo_eve + sexo_per + depto_ocu + horario + fall_les + mayor_menor,
                data = data_arbol3, method = "class")


rpart.plot(arbol3, type = 2, extra = 0, under = TRUE, fallen.leaves = TRUE,
           box.palette = "BuGn", main = "Árbol 3: Tipo de vehículo", cex = 0.6)

```

```{r}
barplot(arbol3$variable.importance, main="Importancia de variables", col="steelblue")
```

```{r}

# 5 escenarios distintos
escenarios <- data.frame(
  sexo_per  = factor(c(2, 1, 2, 1, 2), levels = levels(data_arbol3$sexo_per)),   # Mujer/Hombre
  horario  = factor(c(1, 2, 1, 1, 2), levels = levels(data_arbol3$horario)),   # Día, Noche
  mayor_menor  = factor(c(1, 2, 2, 1, 1), levels = levels(data_arbol3$mayor_menor)),   # Mayor,Menor
  tipo_eve  = factor(c(2, 5, 3, 1, 6), levels = levels(data_arbol3$tipo_eve)), # Choque, Atropello, Vuelco, Colisión, Derrape
  
  depto_ocu = factor(c(1, 6, 14, 18, 22), levels = levels(data_arbol3$depto_ocu)), # Guatemala, Santa Rosa, Quiché, Izabal, Jutiapa
  fall_les = factor(c(1, 1, 2, 2, 2), levels = levels(data_arbol3$fall_les)) # Guatemala, Santa Rosa, Quiché, Izabal, Jutiapa
)

# Ver el dataframe
escenarios

```

```{r}

# Predicción con probabilidades
result <- predict(arbol3, escenarios, type = "prob")
result
```


## Modelo 4: Predecir horario (día/noche)
### En esta predicción si se formo bien el arbol sin necesidad de filtrar ya que sia habia buena distribución en el dataset.
```{r}
data_arbol4 <- datos_consolidados %>%
  filter(fall_les %in% c(1, 2), sexo_per != 9, tipo_eve != 99, tipo_veh != 99, edad_per != 999)
data_arbol4$sexo_per <- factor(data_arbol4$sexo_per)
data_arbol4$tipo_eve <- factor(data_arbol4$tipo_eve)
data_arbol4$tipo_veh <- factor(data_arbol4$tipo_veh)
data_arbol4$depto_ocu <- factor(data_arbol4$depto_ocu)
data_arbol4$zona_ocu <- factor(data_arbol4$zona_ocu)
data_arbol4$fall_les <- factor(data_arbol4$fall_les)
data_arbol4$horario <- factor(data_arbol4$horario)
data_arbol4$mayor_menor <- factor(data_arbol4$mayor_menor)
table(data_arbol4$horario)


```
```{r}
arbol4 <- rpart(horario ~  tipo_eve +sexo_per + tipo_veh + depto_ocu + fall_les + mayor_menor, data = data_arbol4, method = "class")

rpart.plot(arbol4, type = 2, extra = 0, under = TRUE, fallen.leaves = TRUE,
           box.palette = "BuGn", main = "Árbol 4: Horario", cex = 0.6)

```
```{r}
barplot(arbol4$variable.importance, main="Importancia de variables", col="steelblue")
```
```{r}

# 5 escenarios distintos
escenarios <- data.frame(
  sexo_per  = factor(c(2, 1, 2, 1, 2), levels = levels(data_arbol4$sexo_per)),   # Mujer/Hombre
  mayor_menor  = factor(c(1, 2, 2, 1, 1), levels = levels(data_arbol4$mayor_menor)),   # Mayor,Menor
  tipo_eve  = factor(c(2, 5, 3, 1, 6), levels = levels(data_arbol4$tipo_eve)), # Choque, Atropello, Vuelco, Colisión, Derrape
  tipo_veh  = factor(c(4, 1, 3, 2, 5), levels = levels(data_arbol4$tipo_veh)),   # Motocicleta, Automóvil, Pick up, Camioneta sport, Camión
  depto_ocu = factor(c(1, 6, 14, 18, 22), levels = levels(data_arbol4$depto_ocu)), # Guatemala, Santa Rosa, Quiché, Izabal, Jutiapa
  fall_les = factor(c(1, 1, 2, 2, 2), levels = levels(data_arbol4$fall_les)) # Fallecido, Lesionado
)

# Ver el dataframe
escenarios

```

```{r}
# Predicción con probabilidades
result <- predict(arbol4, escenarios, type = "prob")
result
```

```{r}
barplot(arbol4$variable.importance, main="Importancia de variables", col="steelblue")
```

## Modelo 5: Predecir depto ocurrencia
### En esta predicción si se formo bien el arbol pero filtrando el interior del pais. Se excluyó Guatemala.

```{r}
data_arbol5 <- datos_consolidados %>%
  filter(fall_les %in% c(1, 2), sexo_per != 9, tipo_eve != 99,depto_ocu!=1, tipo_veh != 99, edad_per != 999)
data_arbol5$sexo_per <- factor(data_arbol5$sexo_per)
data_arbol5$tipo_eve <- factor(data_arbol5$tipo_eve)
data_arbol5$tipo_veh <- factor(data_arbol5$tipo_veh)
data_arbol5$depto_ocu <- factor(data_arbol5$depto_ocu)
data_arbol5$zona_ocu <- factor(data_arbol5$zona_ocu)
data_arbol5$fall_les <- factor(data_arbol5$fall_les)
data_arbol5$horario <- factor(data_arbol5$horario)
data_arbol5$mayor_menor <- factor(data_arbol5$mayor_menor)
table(data_arbol5$depto_ocu)

```
```{r}
arbol5 <- rpart(depto_ocu ~  tipo_eve +sexo_per + tipo_veh + fall_les + mayor_menor, data = data_arbol5, method = "class")

rpart.plot(arbol5, type = 2, extra = 0, under = TRUE, fallen.leaves = TRUE,
           box.palette = "BuGn", main = "Árbol 5: Departamento de ocurrencia", cex = 0.6)

```
```{r}
barplot(arbol5$variable.importance, main="Importancia de variables", col="steelblue")
```
```{r}

# 5 escenarios distintos
escenarios <- data.frame(
  sexo_per  = factor(c(2, 1, 2, 1, 2), levels = levels(data_bal$sexo_per)),   # Mujer/Hombre
  mayor_menor  = factor(c(1, 2, 2, 1, 1), levels = levels(data_bal$mayor_menor)),   # Mayor,Menor
  tipo_eve  = factor(c(2, 5, 3, 1, 6), levels = levels(data_bal$tipo_eve)), # Choque, Atropello, Vuelco, Colisión, Derrape
  tipo_veh  = factor(c(4, 1, 3, 2, 5), levels = levels(data_bal$tipo_veh)),   # Motocicleta, Automóvil, Pick up, Camioneta sport, Camión
  
  fall_les = factor(c(1, 1, 2, 2, 2), levels = levels(data_bal$depto_ocu)) # Fallecido, Lesionado
)

# Ver el dataframe
escenarios
```

```{r}
# Predicción con probabilidades
result <- predict(arbol5, escenarios, type = "prob")
result
```

### Se intentó analizar el mes de ocurrencia pero no se obtuvo arbol debido al desbalance pero lo interesante es que en en el mes de diciembre hay mas accidentes de transito y luego le sigue diciembre. Además, en junio es donde menos reportes de incidencias hubo.
```{r}
table(data_arbol1$mes_ocu)
```

# BOSQUES ALEATORIOS

```{r}
library(randomForest)
```

## MODELO 1: PREDECIR CONSECUENCIA (FALL/LES) - SIN BALANCEAR

```{r}

data_rf1 <- datos_consolidados %>%
  filter(fall_les %in% c(1, 2), sexo_per != 9, tipo_eve != 99, tipo_veh != 99, edad_per != 999)

data_rf1$sexo_per <- factor(data_rf1$sexo_per)
data_rf1$tipo_eve <- factor(data_rf1$tipo_eve)
data_rf1$tipo_veh <- factor(data_rf1$tipo_veh)
data_rf1$depto_ocu <- factor(data_rf1$depto_ocu)
data_rf1$horario <- factor(data_rf1$horario)
data_rf1$fall_les <- factor(data_rf1$fall_les)

set.seed(123)

data <-  data_rf1[sample(1:nrow(data_rf1)), ]
train_index <- sample(1:nrow(data), 0.7 * nrow(data))
train_data <- data[train_index, ]
test_data <- data[-train_index, ]

modelo_rf1 <- randomForest(fall_les ~ sexo_per + tipo_eve + tipo_veh + depto_ocu,
                           data = train_data, ntree = 100, mtry = 4, importance = TRUE)

modelo_rf1

```
### A diferencia del modelo de arboles de decisión, en el caso de bosques aleatorios si obtuvimos un resultado con un OOB del 16.85%.

```{r}
plot(modelo_rf1)
```
```{r}
predictions <- predict(modelo_rf1, newdata = test_data)
conf_matrix <- table(test_data$fall_les, predictions)
conf_matrix

accuracy <- sum(diag(conf_matrix)) / sum(conf_matrix)
accuracy

```
### Tenemos un accuracy del 83% en el testeo.
```{r}

escenarios <- data.frame(
  sexo_per  = factor(c(2, 1, 2, 1, 2), levels = levels(data_rf1$sexo_per)),
  tipo_eve  = factor(c(2, 5, 3, 1, 6), levels = levels(data_rf1$tipo_eve)),
  tipo_veh  = factor(c(4, 1, 3, 2, 5), levels = levels(data_rf1$tipo_veh)),
  depto_ocu = factor(c(1, 6, 14, 18, 22), levels = levels(data_rf1$depto_ocu)))

pred_rf1 <- predict(modelo_rf1, escenarios, type = "prob")
pred_rf1

```
#### En este modelo no tenemos contra que comparar pero para propositos de evaluar las diferencias con el dataset balanceado vemos el siguiente bosque.

## MODELO 1: PREDECIR CONSECUENCIA (FALL/ LES) - BALANCEADO

```{r}

data_rf1b <- datos_consolidados %>%
  filter(fall_les %in% c(1, 2), sexo_per != 9, tipo_eve != 99, tipo_veh != 99, edad_per != 999)
data_bal <- data_rf1b
set.seed(123)
fallecidos <- data_rf1b %>% filter(fall_les == 1)
lesionados <- data_rf1b %>% filter(fall_les == 2) %>% sample_n(nrow(fallecidos))
data_bal <- bind_rows(fallecidos, lesionados)

# Convertir variables categóricas a factor
data_bal$sexo_per <- factor(data_bal$sexo_per)
data_bal$tipo_eve <- factor(data_bal$tipo_eve)
data_bal$tipo_veh <- factor(data_bal$tipo_veh)
data_bal$depto_ocu <- factor(data_bal$depto_ocu)
data_bal$horario <- factor(data_bal$horario)
data_bal$fall_les <- factor(data_bal$fall_les)

set.seed(123)

data <-  data_bal[sample(1:nrow(data_bal)), ]
train_index <- sample(1:nrow(data), 0.7 * nrow(data))
train_data <- data[train_index, ]
test_data <- data[-train_index, ]

modelo_rf1b <- randomForest(fall_les ~ sexo_per + tipo_eve + tipo_veh + depto_ocu,
                           data = train_data, ntree = 100, mtry = 4, importance = TRUE)

modelo_rf1b

```
### Se obtuvo un OBB del 35% para este caso donde habia balanceo en los registros.
```{r}
plot(modelo_rf1b)
```

```{r}

predictions <- predict(modelo_rf1b, newdata = test_data)
conf_matrix <- table(test_data$fall_les, predictions)
conf_matrix

accuracy <- sum(diag(conf_matrix)) / sum(conf_matrix)
accuracy

```

```{r}
escenarios <- data.frame(
  sexo_per  = factor(c(2, 1, 2, 1, 2), levels = levels(data_bal$sexo_per)),
  tipo_eve  = factor(c(2, 5, 3, 1, 6), levels = levels(data_bal$tipo_eve)),
  tipo_veh  = factor(c(4, 1, 3, 2, 5), levels = levels(data_bal$tipo_veh)),
  depto_ocu = factor(c(1, 6, 14, 18, 22), levels = levels(data_bal$depto_ocu)))

pred_rf1 <- predict(modelo_rf1, escenarios, type = "prob")
pred_rf1


```
### MODELO 2: PREDECIR TIPO DE EVENTO - Excluyendo colisiones

```{r}

# Preparar datos y factores
data_arbol2$tipo_eve   <- factor(data_arbol2$tipo_eve)
data_arbol2$tipo_veh   <- factor(data_arbol2$tipo_veh)
data_arbol2$depto_ocu  <- factor(data_arbol2$depto_ocu)
data_arbol2$horario    <- factor(data_arbol2$horario)
data_arbol2$fall_les   <- factor(data_arbol2$fall_les)
data_arbol2$sexo_per   <- factor(data_arbol2$sexo_per)
data_arbol2$mayor_menor   <- factor(data_arbol2$mayor_menor)

# Entrenar RF
set.seed(123)
data <-  data_arbol2[sample(1:nrow(data_arbol2)), ]
train_index <- sample(1:nrow(data), 0.7 * nrow(data))
train_data <- data[train_index, ]
test_data <- data[-train_index, ]
modelo_rf2 <- randomForest(tipo_eve ~ tipo_veh + depto_ocu + fall_les + mayor_menor + horario + sexo_per,
                           data = train_data, ntree = 50, mtry = 3, importance = TRUE)


modelo_rf2
```
# Se obtuvo muy alto error pero se hara la prediccion para comparar resultados.

```{r}
plot(modelo_rf2)

```
```{r}

predictions <- predict(modelo_rf2, newdata = test_data)
conf_matrix <- table(test_data$fall_les, predictions)
conf_matrix

accuracy <- sum(diag(conf_matrix)) / sum(conf_matrix)
accuracy

```
```{r}

escenarios <- data.frame(
  sexo_per  = factor(c(2, 1, 2, 1, 2), levels = levels(data_arbol2$sexo_per)),   # Mujer/Hombre
  horario  = factor(c(1, 2, 1, 1, 2), levels = levels(data_arbol2$horario)),   # Día, Noche
  mayor_menor  = factor(c(1, 2, 2, 1, 1), levels = levels(data_arbol2$mayor_menor)),   # Mayor,Menor
  tipo_veh  = factor(c(4, 1, 3, 2, 5), levels = levels(data_arbol2$tipo_veh)),   # Motocicleta, Automóvil, Pick up, Camioneta sport, Camión
  depto_ocu = factor(c(1, 6, 14, 18, 22), levels = levels(data_arbol2$depto_ocu)), # Guatemala, Santa Rosa, Quiché, Izabal, Jutiapa
  fall_les = factor(c(1, 1, 2, 2, 2), levels = levels(data_arbol2$fall_les)) # Guatemala, Santa Rosa, Quiché, Izabal, Jutiapa
)
pred_rf2 <- predict(modelo_rf2, escenarios, type = "prob")
pred_rf2

```

### MODELO 2: PREDECIR TIPO DE EVENTO - Incluyendo todos los eventos
```{r}

data_rf2todos <- datos_consolidados %>%
  filter(fall_les %in% c(1, 2), sexo_per != 9, tipo_eve != 99, tipo_veh != 99, edad_per != 999)

data_rf2todos$tipo_eve   <- factor(data_rf2todos$tipo_eve)
data_rf2todos$tipo_veh   <- factor(data_rf2todos$tipo_veh)
data_rf2todos$depto_ocu  <- factor(data_rf2todos$depto_ocu)
data_rf2todos$horario    <- factor(data_rf2todos$horario)
data_rf2todos$fall_les   <- factor(data_rf2todos$fall_les)
data_rf2todos$sexo_per   <- factor(data_rf2todos$sexo_per)
data_rf2todos$mayor_menor   <- factor(data_rf2todos$mayor_menor)

# Entrenar RF
set.seed(123)
data <-  data_rf2todos[sample(1:nrow(data_rf2todos)), ]
train_index <- sample(1:nrow(data), 0.7 * nrow(data))
train_data <- data[train_index, ]
test_data <- data[-train_index, ]
modelo_rf2todos <- randomForest(tipo_eve ~ tipo_veh + depto_ocu + fall_les + mayor_menor + horario + sexo_per ,
                           data = train_data, ntree = 50, mtry = 3, importance = TRUE)


modelo_rf2todos
```
```{r}
plot(modelo_rf2todos)

```
```{r}

predictions <- predict(modelo_rf2todos, newdata = test_data)
conf_matrix <- table(test_data$fall_les, predictions)
conf_matrix

accuracy <- sum(diag(conf_matrix)) / sum(conf_matrix)
accuracy

```

```{r}

escenarios <- data.frame(
  sexo_per  = factor(c(2, 1, 2, 1, 2), levels = levels(data_rf2todos$sexo_per)),   # Mujer/Hombre
  horario  = factor(c(1, 2, 1, 1, 2), levels = levels(data_rf2todos$horario)),   # Día, Noche
  mayor_menor  = factor(c(1, 2, 2, 1, 1), levels = levels(data_rf2todos$mayor_menor)),   # Mayor,Menor
  tipo_veh  = factor(c(4, 1, 3, 2, 5), levels = levels(data_rf2todos$tipo_veh)),   # Motocicleta, Automóvil, Pick up, Camioneta sport, Camión
  depto_ocu = factor(c(1, 6, 14, 18, 22), levels = levels(data_rf2todos$depto_ocu)), # Guatemala, Santa Rosa, Quiché, Izabal, Jutiapa
  fall_les = factor(c(1, 1, 2, 2, 2), levels = levels(data_rf2todos$fall_les)) # Guatemala, Santa Rosa, Quiché, Izabal, Jutiapa
)
pred_rf2 <- predict(modelo_rf2todos, escenarios, type = "prob")
pred_rf2

```
### MODELO 3: PREDICCION DE TIPO DE VEHICULO

```{r}

# Preparar datos y factores
data_arbol3$tipo_veh   <- factor(data_arbol3$tipo_veh)
data_arbol3$tipo_eve   <- factor(data_arbol3$tipo_eve)
data_arbol3$sexo_per   <- factor(data_arbol3$sexo_per)
data_arbol3$depto_ocu  <- factor(data_arbol3$depto_ocu)
data_arbol3$horario    <- factor(data_arbol3$horario)
data_arbol3$fall_les   <- factor(data_arbol3$fall_les)
data_arbol3$mayor_menor   <- factor(data_arbol3$mayor_menor)

# Entrenar RF
set.seed(123)

data <-  data_arbol3[sample(1:nrow(data_arbol3)), ]
train_index <- sample(1:nrow(data), 0.7 * nrow(data))
train_data <- data[train_index, ]
test_data <- data[-train_index, ]

modelo_rf3 <- randomForest(tipo_veh ~ tipo_eve + sexo_per + depto_ocu + horario + fall_les + mayor_menor,
                           data = train_data, ntree = 100, mtry = 4, importance = TRUE)
modelo_rf3

```
```{r}
plot(modelo_rf3)
```
### Se observa que este modelo falla en mas del 50% de las veces tiende mas a negar las predicciones que a establecerlas.

```{r}

predictions <- predict(modelo_rf3, newdata = test_data)
conf_matrix <- table(test_data$fall_les, predictions)
conf_matrix

accuracy <- sum(diag(conf_matrix)) / sum(conf_matrix)
accuracy

```
```{r}

# 5 escenarios distintos
escenarios <- data.frame(
  sexo_per  = factor(c(2, 1, 2, 1, 2), levels = levels(data_arbol3$sexo_per)),   # Mujer/Hombre
  horario  = factor(c(1, 2, 1, 1, 2), levels = levels(data_arbol3$horario)),   # Día, Noche
  mayor_menor  = factor(c(1, 2, 2, 1, 1), levels = levels(data_arbol3$mayor_menor)),   # Mayor,Menor
  tipo_eve  = factor(c(2, 5, 3, 1, 6), levels = levels(data_arbol3$tipo_eve)), # Choque, Atropello, Vuelco, Colisión, Derrape
  
  depto_ocu = factor(c(1, 6, 14, 18, 22), levels = levels(data_arbol3$depto_ocu)), # Guatemala, Santa Rosa, Quiché, Izabal, Jutiapa
  fall_les = factor(c(1, 1, 2, 2, 2), levels = levels(data_arbol3$fall_les)) # Guatemala, Santa Rosa, Quiché, Izabal, Jutiapa
)

predict(modelo_rf3, escenarios,type="prob")
predict

```
## Modelo 4: Prediccion de jornada
```{r}

# Preparar datos y factores
data_arbol4$tipo_veh   <- factor(data_arbol4$tipo_veh)
data_arbol4$tipo_eve   <- factor(data_arbol4$tipo_eve)
data_arbol4$sexo_per   <- factor(data_arbol4$sexo_per)
data_arbol4$depto_ocu  <- factor(data_arbol4$depto_ocu)
data_arbol4$horario    <- factor(data_arbol4$horario)
data_arbol4$fall_les   <- factor(data_arbol4$fall_les)

# Entrenar RF
set.seed(123)

data <-  data_arbol4[sample(1:nrow(data_arbol4)), ]
train_index <- sample(1:nrow(data), 0.7 * nrow(data))
train_data <- data[train_index, ]
test_data <- data[-train_index, ]

modelo_rf4 <- randomForest(horario ~ tipo_eve + sexo_per + depto_ocu + tipo_veh + fall_les + mayor_menor,
                           data = train_data, ntree = 100, mtry = 4, importance = TRUE)
modelo_rf4

```
```{r}
plot(modelo_rf4)

```
```{r}

predictions <- predict(modelo_rf4, newdata = test_data)
conf_matrix <- table(test_data$fall_les, predictions)
conf_matrix

accuracy <- sum(diag(conf_matrix)) / sum(conf_matrix)
accuracy

```
```{r}

escenarios <- data.frame(
  sexo_per  = factor(c(2, 1, 2, 1, 2), levels = levels(data_arbol4$sexo_per)),   # Mujer/Hombre
  mayor_menor  = factor(c(1, 2, 2, 1, 1), levels = levels(data_arbol4$mayor_menor)),   # Mayor,Menor
  tipo_eve  = factor(c(2, 5, 3, 1, 6), levels = levels(data_arbol4$tipo_eve)), # Choque, Atropello, Vuelco, Colisión, Derrape
  tipo_veh  = factor(c(4, 1, 3, 2, 5), levels = levels(data_arbol4$tipo_veh)),   # Motocicleta, Automóvil, Pick up, Camioneta sport, Camión
  depto_ocu = factor(c(1, 6, 14, 18, 22), levels = levels(data_arbol4$depto_ocu)), # Guatemala, Santa Rosa, Quiché, Izabal, Jutiapa
  fall_les = factor(c(1, 1, 2, 2, 2), levels = levels(data_arbol4$fall_les)) # Fallecido, Lesionado
)
predict(modelo_rf4, escenarios,type="prob")
predict

```
## Modelo 5: Prediccion de sexo

```{r}

data_rf5 <- datos_consolidados %>%
  filter(fall_les %in% c(1, 2), sexo_per != 9, tipo_eve != 99, tipo_veh != 99, edad_per != 999)

data_rf5$sexo_per <- factor(data_rf5$sexo_per)
data_rf5$tipo_eve <- factor(data_rf5$tipo_eve)
data_rf5$tipo_veh <- factor(data_rf5$tipo_veh)
data_rf5$depto_ocu <- factor(data_rf5$depto_ocu)
data_rf5$horario <- factor(data_rf5$horario)
data_rf5$fall_les <- factor(data_rf5$fall_les)
data_rf5$mayor_menor <- factor(data_rf5$mayor_menor)

# Entrenar RF
set.seed(123)
data <-  data_rf5[sample(1:nrow(data_rf5)), ]
train_index <- sample(1:nrow(data), 0.7 * nrow(data))
train_data <- data[train_index, ]
test_data <- data[-train_index, ]
modelo_rf5 <- randomForest(sexo_per ~ tipo_veh + depto_ocu + fall_les + horario + tipo_eve + mayor_menor,
                           data = train_data, ntree = 50, mtry = 3, importance = TRUE)


modelo_rf5
```
```{r}
plot(modelo_rf5)
```
```{r}

predictions <- predict(modelo_rf5, newdata = test_data)
conf_matrix <- table(test_data$fall_les, predictions)
conf_matrix

accuracy <- sum(diag(conf_matrix)) / sum(conf_matrix)
accuracy

```

```{r}

escenarios <- data.frame(
  horario  = factor(c(1, 2, 1, 1, 2), levels = levels(data_rf5$horario)),   # Día, Noche
  mayor_menor  = factor(c(1, 2, 2, 1, 1), levels = levels(data_rf5$mayor_menor)),   # Mayor,Menor
  tipo_eve  = factor(c(2, 5, 3, 1, 6), levels = levels(data_rf5$tipo_eve)), # Choque, Atropello, Vuelco, Colisión, Derrape
  tipo_veh  = factor(c(4, 1, 3, 2, 5), levels = levels(data_rf5$tipo_veh)),   # Motocicleta, Automóvil, Pick up, Camioneta sport, Camión
  depto_ocu = factor(c(1, 6, 14, 18, 22), levels = levels(data_rf5$depto_ocu)), # Guatemala, Santa Rosa, Quiché, Izabal, Jutiapa
  fall_les = factor(c(1, 1, 2, 2, 2), levels = levels(data_rf5$fall_les)) # Fallecido, Lesionado
)

predict(modelo_rf5, escenarios,type="prob")
predict

```
#Modelo 6: Prediccion si es mayor o menor

```{r}

data_rf6 <- datos_consolidados %>%
  filter(fall_les %in% c(1, 2), sexo_per != 9, tipo_eve != 99, tipo_veh != 99, edad_per != 999)

data_rf6$sexo_per <- factor(data_rf6$sexo_per)
data_rf6$tipo_eve <- factor(data_rf6$tipo_eve)
data_rf6$tipo_veh <- factor(data_rf6$tipo_veh)
data_rf6$depto_ocu <- factor(data_rf6$depto_ocu)
data_rf6$horario <- factor(data_rf6$horario)
data_rf6$fall_les <- factor(data_rf6$fall_les)
data_rf6$g_hora_5 <- factor(data_rf6$g_hora_5)
data_rf6$mayor_menor <- factor(data_rf6$mayor_menor)

# Entrenar RF
set.seed(123)
data <-  data_rf6[sample(1:nrow(data_rf6)), ]
train_index <- sample(1:nrow(data), 0.7 * nrow(data))
train_data <- data[train_index, ]
test_data <- data[-train_index, ]
modelo_rf6 <- randomForest(mayor_menor ~ tipo_veh + depto_ocu + fall_les + horario + tipo_eve + sexo_per,
                           data = train_data, ntree = 50, mtry = 3, importance = TRUE)


modelo_rf6
```
```{r}
plot(modelo_rf6)
```
```{r}

predictions <- predict(modelo_rf6, newdata = test_data)
conf_matrix <- table(test_data$fall_les, predictions)
conf_matrix

accuracy <- sum(diag(conf_matrix)) / sum(conf_matrix)
accuracy

```
```{r}

escenarios <- data.frame(
  sexo_per  = factor(c(2, 1, 2, 1, 2), levels = levels(data_rf6$sexo_per)),   # Mujer/Hombre
  horario  = factor(c(1, 2, 1, 1, 2), levels = levels(data_rf6$horario)),   # Día, Noche
  
  tipo_eve  = factor(c(2, 5, 3, 1, 6), levels = levels(data_rf6$tipo_eve)), # Choque, Atropello, Vuelco, Colisión, Derrape
  tipo_veh  = factor(c(4, 1, 3, 2, 5), levels = levels(data_rf6$tipo_veh)),   # Motocicleta, Automóvil, Pick up, Camioneta sport, Camión
  depto_ocu = factor(c(1, 6, 14, 18, 22), levels = levels(data_rf6$depto_ocu)), # Guatemala, Santa Rosa, Quiché, Izabal, Jutiapa
  fall_les = factor(c(1, 1, 2, 2, 2), levels = levels(data_rf6$fall_les)) # Fallecido, Lesionado
)
predict(modelo_rf6, escenarios,type="prob")
predict

```









