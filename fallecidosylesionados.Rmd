---
title: "R Notebook"
output: html_notebook
---


Nombre: Brndon René Portillo González
Proyecto: Fase II

Se cargan algunas de las librerías para iniciar con la exploración, los datos fueron previamente revisados y se tienen 8 fuentes de excel y 8 es SSPS.

```{r}
install.packages(c("readxl", "dplyr"))
library(readxl)
library(dplyr)
```

## Se installan las librerias para arboles de decision
```{r}
install.packages("rpart")
install.packages("rpart.plot")
```

```{r}
ruta <- "C:/Users/Brandon Portillo/Desktop/Nueva carpeta/4to Trimestre/PFinalF2/Fallecidos y lesionados/Excel"

archivos_excel <- list.files(path = ruta, pattern = "\\.xls[x]?$", full.names = TRUE)
print(archivos_excel)
```
Se pueden visualizar las 8 fuentes y a continuación se procede a consolidar las partes. En cada excel algunos tienen 3 hojas pero solo 1 de cada 3 contiene información y todas las fuentes se trata de la Sheet1 la que nos interesa consultar. Además se validó que las columnas se llamaran igual, la llave primaria se llamaba Num_corre, núm_corre y num_corre.Se eliminó la columna area_geo_ocurr ya que solo aparecia en 2 dataset y no contiene mayor segmentación.

```{r}
lista_datos <- lapply(archivos_excel, function(archivo) {
  
  # Leer la hoja "Sheet1" (podés cambiar el nombre si tus archivos tienen otra hoja)
  df <- read_excel(archivo, sheet = "Sheet1")
  
  return(df)
})

# Combinar todos los dataframes en uno solo
datos_excel <- bind_rows(lista_datos)

# Verificar resultado
glimpse(datos_excel)
```
```{r}
head(datos_excel)

```
```{r}
install.packages("haven")
```


```{r}
library(haven)
```

Ahora se procede a importar la información de los archivos .sav
Para ello se instala y se importa la libreria haven
```{r}
ruta_spss <- "C:/Users/Brandon Portillo/Desktop/Nueva carpeta/4to Trimestre/PFinalF2/Fallecidos y lesionados/SPSS"

archivos_spss <- list.files(path = ruta_spss, pattern = "\\.sav$", full.names = TRUE)
print(archivos_spss)

```
```{r}
# Leer cada archivo y guardar en una lista
lista_spss <- lapply(archivos_spss, function(archivo) {
  df <- read_sav(archivo)
  return(df)
})
```

Se visualiza el contenido de los encabezados
```{r}
names(lista_spss[[1]])
```
Se visualizan los primeros datos...

```{r}

head(lista_spss[[1]])
```
Se consolidan los SSPS

```{r}

nombres_spss <- lapply(archivos_spss, function(archivo) {
  df <- read_sav(archivo)
  names(df)
})

for (i in seq_along(archivos_spss)) {
  cat("\n Archivo:", basename(archivos_spss[i]), "\n")
  print(nombres_spss[[i]])
}
```


De los archivos SPSS solo se considera el del año 2021 ya que los demás están incompletos porque les faltan muchas variables a todos en diferentes puntos y eso no favorece nuestro proceso de mineria de datos.
```{r}

ruta_archivo <- "C:/Users/Brandon Portillo/Desktop/Nueva carpeta/4to Trimestre/PFinalF2/Fallecidos y lesionados/SPSS/2021-Fallecidos y lesionados.sav"

# Leer el archivo
fallecidos_2021 <- read_sav(ruta_archivo)
head(fallecidos_2021)

```
```{r}
fallecidos_2021 <- fallecidos_2021 %>%
  select(-zona_ciudad)
head(fallecidos_2021)
```

Ahora se tienen también 25 variables para analizar, se consolidará esta información a los 8 datasets de excel. La columna que se ignoró fue la de zona_ciudad ya que está redundante y no es comun respecto al otro dataset.

Se procede a explorar que columnas coinciden entonces
```{r}
columnas_comunes <- intersect(names(datos_excel), names(fallecidos_2021))

length(columnas_comunes)    # cuántas columnas coinciden
columnas_comunes            # nombres de las columnas comunes
```


```{r}
datos_excel_comunes <- datos_excel[, columnas_comunes, drop = FALSE]
fallecidos_2021_comunes <- fallecidos_2021[, columnas_comunes, drop = FALSE]

# Se unen datasets
datos_consolidados <- bind_rows(datos_excel_comunes, fallecidos_2021_comunes)
head(datos_consolidados)
dim(datos_consolidados)
```

Se procede a trabajar con los primeros modelos para analisis de los datos integrando la información de accidentes de transito de los años 2015 a 2023 respectivamente lo que corresponde a 9 años de registros históricos reportados por la PNC.

Acontinuación se procede a aplicar los modelos de Arboles de decision...


```{r}

library(rpart)
library(rpart.plot)

datos_consolidados$horario <- ifelse( datos_consolidados$hora_ocu >= 6 &  datos_consolidados$hora_ocu <= 18, 1, 2)
# 1 es dia y 2 es noche
# Filtrar y balancear clases
data_arbol <- datos_consolidados %>%
  filter(fall_les %in% c(1, 2), sexo_per != 9, tipo_eve != 99, tipo_veh != 99, edad_per != 999)
#data_bal <- data_arbol
set.seed(123)
fallecidos <- data_arbol %>% filter(fall_les == 1)
lesionados <- data_arbol %>% filter(fall_les == 2) %>% sample_n(nrow(fallecidos))
data_bal <- bind_rows(fallecidos, lesionados)

# Convertir variables categóricas a factor
data_bal$sexo_per <- factor(data_bal$sexo_per)
data_bal$tipo_eve <- factor(data_bal$tipo_eve)
data_bal$tipo_veh <- factor(data_bal$tipo_veh)
data_bal$depto_ocu <- factor(data_bal$depto_ocu)
data_bal$horario <- factor(data_bal$horario)

```

```{r}
# Calcular conteos y porcentajes por departamento
resumen <- data_bal %>%
  filter(fall_les %in% c(1, 2)) %>%
  group_by(depto_ocu, fall_les) %>%
  summarise(casos = n(), .groups = "drop") %>%
  group_by(depto_ocu) %>%
  summarise(
    Fallecido = sum(casos[fall_les == 1], na.rm = TRUE),
    Lesionado = sum(casos[fall_les == 2], na.rm = TRUE)
  ) %>%
  mutate(
    Total = Fallecido + Lesionado,
    pct_fallecido = round(Fallecido / Total * 100, 2),
    pct_lesionado = round(Lesionado / Total * 100, 2)
  ) %>%
  arrange(desc(pct_fallecido)) 
resumen
```


```{r}
table(data_bal$fall_les)
```

### Modelo 1: Predecir gravedad (fall_les)

```{r}

# Árbol con más variables y parámetros ajustados
arbol1 <- rpart(fall_les ~ sexo_per + tipo_eve + tipo_veh + depto_ocu + horario,
                data = data_bal, method = "class")

rpart.plot(arbol1, type = 2, extra = 0, under = TRUE, fallen.leaves = TRUE,
           box.palette = "BuGn", main = "Árbol 1: Gravedad del accidente", cex=0.5)

```
```{r}


#Escenario de prueba
caso1 <- data.frame(
  sexo_per = factor(2, levels = levels(data_bal$sexo_per)),   # Mujer
  tipo_eve = factor(2, levels = levels(data_bal$tipo_eve)),   # Ej. vuelco
  tipo_veh = factor(2, levels = levels(data_bal$tipo_veh)),   # Ej. motocicleta
  depto_ocu = factor(2, levels = levels(data_bal$depto_ocu)), # Departamento  depto_ocu = factor(2, levels = levels(data_bal$depto_ocu)), # Departamento interior
  horario = factor("Día", levels = levels(data_bal$horario))   # Día
)

# Predicción con probabilidades
result <- predict(arbol1, caso1, type = "prob")
result
```


### Modelo 2: Predecir tipo de evento (tipo_eve)
```{r}
data_arbol2 <- datos_consolidados %>%
  filter(fall_les %in% c(1, 2), sexo_per != 9, tipo_eve != 99,tipo_eve!=1, tipo_veh != 99, edad_per != 999)
data_arbol2$tipo_veh <- factor(data_arbol2$tipo_veh)
data_arbol2$depto_ocu <- factor(data_arbol2$depto_ocu)
data_arbol2$horario <- factor(data_arbol2$horario)
data_arbol2$fall_les <- factor(data_arbol2$fall_les)

table(data_arbol2$tipo_eve)
table(data_arbol$tipo_eve)
```

```{r}


arbol2 <- rpart(tipo_eve ~  tipo_veh +depto_ocu + fall_les + horario , data = data_arbol2, method = "class")
rpart.plot(arbol2,type=2,extra=0, under=TRUE,fallen.leaves = TRUE,box.palette = "BuGn", main = "Árbol 2: Tipo de evento", cex=0.5)

```
```{r}
# Crear escenario de prueba
caso2 <- data.frame(
  tipo_veh = factor(1, levels = levels(data_arbol2$tipo_veh)),
  depto_ocu = factor(1, levels = levels(data_arbol2$depto_ocu)),
  horario = factor(1, levels = levels(data_arbol2$horario)),
  fall_les = factor(1, levels = levels(data_arbol2$fall_les))
)

# Predicción con probabilidades
result <- predict(arbol2, caso2, type = "prob")
result
```
### Modelo 3: Predcir tipo de vehiculo
```{r}
data_arbol3 <- datos_consolidados %>%
  filter(fall_les %in% c(1, 2), sexo_per != 9, tipo_eve != 99, tipo_veh != 99,tipo_veh != 4, edad_per != 999)
data_arbol3$sexo_per <- factor(data_arbol3$sexo_per)
data_arbol3$tipo_eve <- factor(data_arbol3$tipo_eve)
data_arbol3$tipo_veh <- factor(data_arbol3$tipo_veh)
data_arbol3$depto_ocu <- factor(data_arbol3$depto_ocu)
data_arbol3$zona_ocu <- factor(data_arbol3$zona_ocu)
data_arbol3$fall_les <- factor(data_arbol3$fall_les)
data_arbol3$horario <- factor(data_arbol3$horario)
table(data_arbol3$tipo_veh)
```


```{r}

# Árbol para tipo de vehículo
arbol3 <- rpart(tipo_veh ~ tipo_eve + sexo_per + depto_ocu + horario + fall_les,
                data = data_arbol3, method = "class")


rpart.plot(arbol3, type = 2, extra = 0, under = TRUE, fallen.leaves = TRUE,
           box.palette = "BuGn", main = "Árbol 3: Tipo de vehículo", cex = 0.6)

```
```{r}
# Crear escenario de prueba
caso3 <- data.frame(
  tipo_eve = factor(1, levels = levels(data_arbol3$tipo_eve)),
  depto_ocu = factor(1, levels = levels(data_arbol3$depto_ocu)),
  sexo_per = factor(1, levels = levels(data_arbol3$sexo_per)),
  horario = factor(1, levels = levels(data_arbol3$horario)),
  fall_les = factor(2, levels = levels(data_arbol3$fall_les))
)

# Predicción con probabilidades
result <- predict(arbol3, caso3, type = "prob")
result
```


### Modelo 4: Predecir horario (día/noche)
```{r}
data_arbol4 <- datos_consolidados %>%
  filter(fall_les %in% c(1, 2), sexo_per != 9, tipo_eve != 99, tipo_veh != 99, edad_per != 999)
data_arbol4$sexo_per <- factor(data_arbol4$sexo_per)
data_arbol4$tipo_eve <- factor(data_arbol4$tipo_eve)
data_arbol4$tipo_veh <- factor(data_arbol4$tipo_veh)
data_arbol4$depto_ocu <- factor(data_arbol4$depto_ocu)
data_arbol4$zona_ocu <- factor(data_arbol4$zona_ocu)
data_arbol4$fall_les <- factor(data_arbol4$fall_les)
data_arbol4$horario <- factor(data_arbol4$horario)
table(data_arbol4$horario)


```

```{r}
arbol4 <- rpart(horario ~  tipo_eve +sexo_per + tipo_veh + depto_ocu + fall_les, data = data_arbol4, method = "class")

rpart.plot(arbol4, type = 2, extra = 0, under = TRUE, fallen.leaves = TRUE,
           box.palette = "BuGn", main = "Árbol 4: Horario", cex = 0.6)

```
```{r}
caso4 <- data.frame(
  tipo_eve = factor(1, levels = levels(data_arbol3$tipo_eve)),
  tipo_veh = factor(1, levels = levels(data_arbol3$tipo_veh)),
  depto_ocu = factor(1, levels = levels(data_arbol3$depto_ocu)),
  sexo_per = factor(1, levels = levels(data_arbol3$sexo_per)),
  fall_les = factor(2, levels = levels(data_arbol3$fall_les))
)

# Predicción con probabilidades
result <- predict(arbol4, caso4, type = "prob")
result
```
### GRAFICOS DE RELACION ENTRE VARIABLES


```{r}
barplot(arbol1$variable.importance, main="Importancia de variables", col="steelblue")
```
```{r}
barplot(arbol2$variable.importance, main="Importancia de variables", col="steelblue")
```
```{r}
barplot(arbol3$variable.importance, main="Importancia de variables", col="steelblue")
```
```{r}
barplot(arbol4$variable.importance, main="Importancia de variables", col="steelblue")
```
### BOSQUES ALEATORIOS

```{r}

install.packages("randomForest")
library(randomForest)

```

### MODELO 1: PREDECIR CONSECUENCIA (FALL/LES) - SIN BALANCEAR

```{r}

data_rf1 <- datos_consolidados %>%
  filter(fall_les %in% c(1, 2), sexo_per != 9, tipo_eve != 99, tipo_veh != 99, edad_per != 999)

data_rf1$sexo_per <- factor(data_rf1$sexo_per)
data_rf1$tipo_eve <- factor(data_rf1$tipo_eve)
data_rf1$tipo_veh <- factor(data_rf1$tipo_veh)
data_rf1$depto_ocu <- factor(data_rf1$depto_ocu)
data_rf1$horario <- factor(data_rf1$horario)
data_rf1$fall_les <- factor(data_rf1$fall_les)

set.seed(123)

data <-  data_rf1[sample(1:nrow(data_rf1)), ]
train_index <- sample(1:nrow(data), 0.7 * nrow(data))
train_data <- data[train_index, ]
test_data <- data[-train_index, ]

modelo_rf1 <- randomForest(fall_les ~ sexo_per + tipo_eve + tipo_veh + depto_ocu + horario,
                           data = train_data, ntree = 100, mtry = 4, importance = TRUE)

modelo_rf1

```

```{r}
plot(modelo_rf1)
```
```{r}

predictions <- predict(modelo_rf1, newdata = test_data)
conf_matrix <- table(test_data$fall_les, predictions)
conf_matrix

accuracy <- sum(diag(conf_matrix)) / sum(conf_matrix)
accuracy

```
```{r}

casorf1 <- data.frame(sexo_per = factor(2, levels = levels(data_rf1$sexo_per)),
                    tipo_eve = factor(2, levels = levels(data_rf1$tipo_eve)),
                    tipo_veh = factor(1, levels = levels(data_rf1$tipo_veh)),
                    depto_ocu = factor(2, levels = levels(data_rf1$depto_ocu)),
                    horario = factor(1, levels = levels(data_rf1$horario)))

predict(modelo_rf1, casorf1,type="prob")
predict

```
### MODELO 1: PREDECIR CONSECUENCIA (FALL/ LES) - BALANCEADO

```{r}

data_rf1b <- datos_consolidados %>%
  filter(fall_les %in% c(1, 2), sexo_per != 9, tipo_eve != 99, tipo_veh != 99, edad_per != 999)
data_bal <- data_rf1b
set.seed(123)
fallecidos <- data_arbol %>% filter(fall_les == 1)
lesionados <- data_arbol %>% filter(fall_les == 2) %>% sample_n(nrow(fallecidos))
data_bal <- bind_rows(fallecidos, lesionados)

# Convertir variables categóricas a factor
data_bal$sexo_per <- factor(data_bal$sexo_per)
data_bal$tipo_eve <- factor(data_bal$tipo_eve)
data_bal$tipo_veh <- factor(data_bal$tipo_veh)
data_bal$depto_ocu <- factor(data_bal$depto_ocu)
data_bal$horario <- factor(data_bal$horario)
data_bal$fall_les <- factor(data_bal$fall_les)

set.seed(123)

data <-  data_bal[sample(1:nrow(data_bal)), ]
train_index <- sample(1:nrow(data), 0.7 * nrow(data))
train_data <- data[train_index, ]
test_data <- data[-train_index, ]

modelo_rf1b <- randomForest(fall_les ~ sexo_per + tipo_eve + tipo_veh + depto_ocu + horario,
                           data = train_data, ntree = 100, mtry = 4, importance = TRUE)

modelo_rf1b

```
```{r}
plot(modelo_rf1b)
```
```{r}

predictions <- predict(modelo_rf1b, newdata = test_data)
conf_matrix <- table(test_data$fall_les, predictions)
conf_matrix

accuracy <- sum(diag(conf_matrix)) / sum(conf_matrix)
accuracy

```

```{r}

casorf1b <- data.frame(sexo_per = factor(2, levels = levels(data_bal$sexo_per)),
                    tipo_eve = factor(2, levels = levels(data_bal$tipo_eve)),
                    tipo_veh = factor(1, levels = levels(data_bal$tipo_veh)),
                    depto_ocu = factor(2, levels = levels(data_bal$depto_ocu)),
                    horario = factor(1, levels = levels(data_bal$horario)))

predict(modelo_rf1b, casorf1b,type="prob")
predict

```
### MODELO 2: PREDECIR TIPO DE EVENTO - Excluyendo colisiones

```{r}

# Preparar datos y factores
data_arbol2$tipo_eve   <- factor(data_arbol2$tipo_eve)
data_arbol2$tipo_veh   <- factor(data_arbol2$tipo_veh)
data_arbol2$depto_ocu  <- factor(data_arbol2$depto_ocu)
data_arbol2$horario    <- factor(data_arbol2$horario)
data_arbol2$fall_les   <- factor(data_arbol2$fall_les)
data_arbol2$sexo_per   <- factor(data_arbol2$sexo_per)
data_arbol2$g_hora_5   <- factor(data_arbol2$g_hora_5)

# Entrenar RF
set.seed(123)
data <-  data_arbol2[sample(1:nrow(data_arbol2)), ]
train_index <- sample(1:nrow(data), 0.7 * nrow(data))
train_data <- data[train_index, ]
test_data <- data[-train_index, ]
modelo_rf2 <- randomForest(tipo_eve ~ tipo_veh + depto_ocu + fall_les + g_hora_5 + sexo_per,
                           data = train_data, ntree = 50, mtry = 3, importance = TRUE)


modelo_rf2
```

```{r}
plot(modelo_rf2)

```
```{r}

predictions <- predict(modelo_rf2, newdata = test_data)
conf_matrix <- table(test_data$fall_les, predictions)
conf_matrix

accuracy <- sum(diag(conf_matrix)) / sum(conf_matrix)
accuracy

```
```{r}

casorf2 <- data.frame(sexo_per = factor(2, levels = levels(data_arbol2$sexo_per)),
                    fall_les = factor(2, levels = levels(data_arbol2$fall_les)),
                    tipo_veh = factor(1, levels = levels(data_arbol2$tipo_veh)),
                    depto_ocu = factor(2, levels = levels(data_arbol2$depto_ocu)),
                    g_hora_5 = factor(1, levels = levels(data_arbol2$g_hora_5)))

predict(modelo_rf2, casorf2,type="prob")
predict

```

### MODELO 2: PREDECIR TIPO DE EVENTO - Incluyendo todos los eventos
```{r}

data_rf2 <- datos_consolidados %>%
  filter(fall_les %in% c(1, 2), sexo_per != 9, tipo_eve != 99, tipo_veh != 99, edad_per != 999)

data_rf2$sexo_per <- factor(data_rf2$sexo_per)
data_rf2$tipo_eve <- factor(data_rf2$tipo_eve)
data_rf2$tipo_veh <- factor(data_rf2$tipo_veh)
data_rf2$depto_ocu <- factor(data_rf2$depto_ocu)
data_rf2$horario <- factor(data_rf2$horario)
data_rf2$fall_les <- factor(data_rf2$fall_les)
data_rf2$g_hora_5 <- factor(data_rf2$g_hora_5)

# Entrenar RF
set.seed(123)
data <-  data_rf2[sample(1:nrow(data_rf2)), ]
train_index <- sample(1:nrow(data), 0.7 * nrow(data))
train_data <- data[train_index, ]
test_data <- data[-train_index, ]
modelo_rf2 <- randomForest(tipo_eve ~ tipo_veh + depto_ocu + fall_les + g_hora_5 + sexo_per ,
                           data = train_data, ntree = 50, mtry = 3, importance = TRUE)


modelo_rf2
```
```{r}
plot(modelo_rf2)

```
```{r}

predictions <- predict(modelo_rf2, newdata = test_data)
conf_matrix <- table(test_data$fall_les, predictions)
conf_matrix

accuracy <- sum(diag(conf_matrix)) / sum(conf_matrix)
accuracy

```

```{r}

casorf2 <- data.frame(sexo_per = factor(2, levels = levels(data$sexo_per)),
                    fall_les = factor(2, levels = levels(data$fall_les)),
                    tipo_veh = factor(1, levels = levels(data$tipo_veh)),
                    depto_ocu = factor(2, levels = levels(data$depto_ocu)),
                    g_hora_5 = factor(1, levels = levels(data$g_hora_5)))

predict(modelo_rf2, casorf2,type="prob")
predict

```
### MODELO 3: PREDICCION DE TIPO DE VEHICULO

```{r}

# Preparar datos y factores
data_arbol3$tipo_veh   <- factor(data_arbol3$tipo_veh)
data_arbol3$tipo_eve   <- factor(data_arbol3$tipo_eve)
data_arbol3$sexo_per   <- factor(data_arbol3$sexo_per)
data_arbol3$depto_ocu  <- factor(data_arbol3$depto_ocu)
data_arbol3$horario    <- factor(data_arbol3$horario)
data_arbol3$fall_les   <- factor(data_arbol3$fall_les)
data_arbol3$g_hora_5   <- factor(data_arbol3$g_hora_5)

# Entrenar RF
set.seed(123)

data <-  data_arbol3[sample(1:nrow(data_arbol3)), ]
train_index <- sample(1:nrow(data), 0.7 * nrow(data))
train_data <- data[train_index, ]
test_data <- data[-train_index, ]

modelo_rf3 <- randomForest(tipo_veh ~ tipo_eve + sexo_per + depto_ocu + g_hora_5 + fall_les,
                           data = train_data, ntree = 100, mtry = 4, importance = TRUE)
modelo_rf3

```
```{r}
plot(modelo_rf3)
```
```{r}

predictions <- predict(modelo_rf3, newdata = test_data)
conf_matrix <- table(test_data$fall_les, predictions)
conf_matrix

accuracy <- sum(diag(conf_matrix)) / sum(conf_matrix)
accuracy

```
```{r}

casorf3 <- data.frame(sexo_per = factor(2, levels = levels(data$sexo_per)),
                    fall_les = factor(2, levels = levels(data$fall_les)),
                    tipo_eve = factor(1, levels = levels(data$tipo_eve)),
                    depto_ocu = factor(2, levels = levels(data$depto_ocu)),
                    g_hora_5 = factor(1, levels = levels(data$g_hora_5)))

predict(modelo_rf3, casorf3,type="prob")
predict

```

```{r}

# Preparar datos y factores
data_arbol4$tipo_veh   <- factor(data_arbol4$tipo_veh)
data_arbol4$tipo_eve   <- factor(data_arbol4$tipo_eve)
data_arbol4$sexo_per   <- factor(data_arbol4$sexo_per)
data_arbol4$depto_ocu  <- factor(data_arbol4$depto_ocu)
data_arbol4$horario    <- factor(data_arbol4$horario)
data_arbol4$fall_les   <- factor(data_arbol4$fall_les)

# Entrenar RF
set.seed(123)

data <-  data_arbol4[sample(1:nrow(data_arbol4)), ]
train_index <- sample(1:nrow(data), 0.7 * nrow(data))
train_data <- data[train_index, ]
test_data <- data[-train_index, ]

modelo_rf4 <- randomForest(horario ~ tipo_eve + sexo_per + depto_ocu + tipo_veh + fall_les,
                           data = train_data, ntree = 100, mtry = 4, importance = TRUE)
modelo_rf4

```
```{r}
plot(modelo_rf4)

```
```{r}

predictions <- predict(modelo_rf4, newdata = test_data)
conf_matrix <- table(test_data$fall_les, predictions)
conf_matrix

accuracy <- sum(diag(conf_matrix)) / sum(conf_matrix)
accuracy

```
```{r}

casorf4 <- data.frame(sexo_per = factor(2, levels = levels(data$sexo_per)),
                    fall_les = factor(2, levels = levels(data$fall_les)),
                    tipo_eve = factor(1, levels = levels(data$tipo_eve)),
                    depto_ocu = factor(2, levels = levels(data$depto_ocu)),
                    tipo_veh = factor(1, levels = levels(data$tipo_veh)))

predict(modelo_rf4, casorf4,type="prob")
predict

```
```{r}

data_rf5 <- datos_consolidados %>%
  filter(fall_les %in% c(1, 2), sexo_per != 9, tipo_eve != 99, tipo_veh != 99, edad_per != 999)

data_rf5$sexo_per <- factor(data_rf5$sexo_per)
data_rf5$tipo_eve <- factor(data_rf5$tipo_eve)
data_rf5$tipo_veh <- factor(data_rf5$tipo_veh)
data_rf5$depto_ocu <- factor(data_rf5$depto_ocu)
data_rf5$horario <- factor(data_rf5$horario)
data_rf5$fall_les <- factor(data_rf5$fall_les)
data_rf5$g_hora_5 <- factor(data_rf5$g_hora_5)

# Entrenar RF
set.seed(123)
data <-  data_rf5[sample(1:nrow(data_rf5)), ]
train_index <- sample(1:nrow(data), 0.7 * nrow(data))
train_data <- data[train_index, ]
test_data <- data[-train_index, ]
modelo_rf5 <- randomForest(sexo_per ~ tipo_veh + depto_ocu + fall_les + g_hora_5 + tipo_eve ,
                           data = train_data, ntree = 50, mtry = 3, importance = TRUE)


modelo_rf5
```
```{r}
plot(modelo_rf5)
```
```{r}

predictions <- predict(modelo_rf5, newdata = test_data)
conf_matrix <- table(test_data$fall_les, predictions)
conf_matrix

accuracy <- sum(diag(conf_matrix)) / sum(conf_matrix)
accuracy

```

```{r}

casorf5 <- data.frame(g_hora_5 = factor(2, levels = levels(data$g_hora_5)),
                    fall_les = factor(2, levels = levels(data$fall_les)),
                    tipo_eve = factor(1, levels = levels(data$tipo_eve)),
                    depto_ocu = factor(2, levels = levels(data$depto_ocu)),
                    tipo_veh = factor(1, levels = levels(data$tipo_veh)))

predict(modelo_rf5, casorf5,type="prob")
predict

```
```{r}

data_rf6 <- datos_consolidados %>%
  filter(fall_les %in% c(1, 2), sexo_per != 9, tipo_eve != 99, tipo_veh != 99, edad_per != 999)

data_rf6$sexo_per <- factor(data_rf6$sexo_per)
data_rf6$tipo_eve <- factor(data_rf6$tipo_eve)
data_rf6$tipo_veh <- factor(data_rf6$tipo_veh)
data_rf6$depto_ocu <- factor(data_rf6$depto_ocu)
data_rf6$horario <- factor(data_rf6$horario)
data_rf6$fall_les <- factor(data_rf6$fall_les)
data_rf6$g_hora_5 <- factor(data_rf6$g_hora_5)
data_rf6$mayor_menor <- factor(data_rf6$mayor_menor)

# Entrenar RF
set.seed(123)
data <-  data_rf6[sample(1:nrow(data_rf6)), ]
train_index <- sample(1:nrow(data), 0.7 * nrow(data))
train_data <- data[train_index, ]
test_data <- data[-train_index, ]
modelo_rf6 <- randomForest(mayor_menor ~ tipo_veh + depto_ocu + fall_les + g_hora_5 + tipo_eve + sexo_per,
                           data = train_data, ntree = 50, mtry = 3, importance = TRUE)


modelo_rf6
```
```{r}
plot(modelo_rf6)
```
```{r}

predictions <- predict(modelo_rf6, newdata = test_data)
conf_matrix <- table(test_data$fall_les, predictions)
conf_matrix

accuracy <- sum(diag(conf_matrix)) / sum(conf_matrix)
accuracy

```
```{r}

casorf6 <- data.frame(g_hora_5 = factor(2, levels = levels(data$g_hora_5)),
                    fall_les = factor(2, levels = levels(data$fall_les)),
                    tipo_eve = factor(1, levels = levels(data$tipo_eve)),
                    depto_ocu = factor(2, levels = levels(data$depto_ocu)),
                    sexo_per = factor(2, levels = levels(data$sexo_per)),
                    tipo_veh = factor(1, levels = levels(data$tipo_veh)))

predict(modelo_rf6, casorf6,type="prob")
predict

```